{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/app/api/agora/start-agent/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport axios from \"axios\";\nimport pkg from \"agora-token\";\nconst { RtcTokenBuilder, RtcRole } = pkg;\n\n// Mock product data - in production, this would fetch from a database\nasync function fetchProduct() {\n  return {\n    id: \"1\",\n    name: \"Sony WH-1000XM5 Wireless Noise Cancelling Headphones\",\n    price: 399.99,\n    originalPrice: 449.99,\n    discount: 11,\n    rating: 4.7,\n    reviewCount: 2847,\n    inStock: true,\n    description:\n      \"Industry-leading noise cancellation with Dual Noise Sensor technology. Premium sound quality with LDAC codec support. Up to 30-hour battery life with quick charge. Comfortable design with soft pressure-relieving ear pads.\",\n    specifications: {\n      \"Noise Cancellation\": \"Industry-leading with Dual Noise Sensor\",\n      \"Battery Life\": \"Up to 30 hours\",\n      \"Quick Charge\": \"3 min charge = 3 hours playback\",\n      Connectivity: \"Bluetooth 5.2, NFC, 3.5mm jack\",\n      Weight: \"250g\",\n      Color: \"Black, Silver, Blue\",\n    },\n    images: [\n      \"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800\",\n      \"https://images.unsplash.com/photo-1484704849700-f032a568e944?w=800\",\n      \"https://images.unsplash.com/photo-1572569511254-d8f925fe2cbb?w=800\",\n    ],\n    reviews: [\n      {\n        id: 1,\n        userName: \"Sarah M.\",\n        rating: 5,\n        date: \"2024-01-15\",\n        title: \"Best headphones I've ever owned!\",\n        comment:\n          \"The noise cancellation is incredible. I can barely hear anything when these are on. Sound quality is amazing and the battery lasts forever. Worth every penny!\",\n        verified: true,\n      },\n      {\n        id: 2,\n        userName: \"Michael T.\",\n        rating: 5,\n        date: \"2024-01-10\",\n        title: \"Perfect for travel\",\n        comment:\n          \"Used these on a 12-hour flight and they were a game changer. Comfortable for long periods and the noise cancellation made the flight so much better.\",\n        verified: true,\n      },\n      {\n        id: 3,\n        userName: \"Jessica L.\",\n        rating: 4,\n        date: \"2024-01-08\",\n        title: \"Great sound, minor comfort issue\",\n        comment:\n          \"Sound quality is excellent and noise cancellation works well. Only complaint is they can get a bit warm after wearing for several hours, but overall very satisfied.\",\n        verified: true,\n      },\n      {\n        id: 4,\n        userName: \"David K.\",\n        rating: 5,\n        date: \"2024-01-05\",\n        title: \"Worth the investment\",\n        comment:\n          \"I was hesitant about the price, but these are absolutely worth it. The build quality is premium and they sound incredible. Battery life is as advertised.\",\n        verified: true,\n      },\n      {\n        id: 5,\n        userName: \"Emily R.\",\n        rating: 4,\n        date: \"2024-01-03\",\n        title: \"Excellent but pricey\",\n        comment:\n          \"These are fantastic headphones with great features. The only reason I'm giving 4 stars is the price point, but if you can afford them, they're top tier.\",\n        verified: true,\n      },\n      {\n        id: 6,\n        userName: \"Robert P.\",\n        rating: 5,\n        date: \"2023-12-28\",\n        title: \"Outstanding quality\",\n        comment:\n          \"The sound clarity is unmatched. I use these for both music and calls, and the microphone quality is excellent. The touch controls are intuitive and responsive.\",\n        verified: true,\n      },\n      {\n        id: 7,\n        userName: \"Lisa W.\",\n        rating: 4,\n        date: \"2023-12-25\",\n        title: \"Great for work from home\",\n        comment:\n          \"Perfect for video calls and blocking out background noise. The comfort is good for all-day wear. Only wish the case was a bit smaller for travel.\",\n        verified: true,\n      },\n    ],\n  };\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { channel, userId, token } = body;\n\n    console.log(`[POST] /api/agora/start-agent`);\n    console.log(\n      \"Request body:\",\n      JSON.stringify(\n        { channel, userId, token: token?.substring(0, 20) + \"...\" },\n        null,\n        2\n      )\n    );\n\n    if (!channel || !userId || !token) {\n      return NextResponse.json(\n        { error: \"Channel, userId, and token are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Get product context\n    const product = await fetchProduct();\n    const context = `You are a helpful shopping assistant for an e-commerce website. \nYour primary focus is helping customers with this specific product, but you can also answer related shopping questions.\n\nProduct: ${product.name}\nPrice: $${product.price} (Original: $${product.originalPrice}, Save ${\n      product.discount\n    }%)\nRating: ${product.rating}/5 stars (${product.reviewCount} reviews)\nStock Status: ${product.inStock ? \"In Stock\" : \"Out of Stock\"}\nDescription: ${product.description}\n\nSpecifications:\n${Object.entries(product.specifications)\n  .map(([key, value]) => `- ${key}: ${value}`)\n  .join(\"\\n\")}\n\nAvailable Colors: Black, Silver, Blue\n\nRecent Customer Reviews:\n${product.reviews\n  .slice(0, 5)\n  .map(\n    (r: any) =>\n      `â€¢ ${r.userName} (${r.rating}/5 stars): \"${r.title}\" - ${r.comment}`\n  )\n  .join(\"\\n\\n\")}\n\nIMPORTANT RULES:\n1. Answer questions about this product, including: features, reviews, pricing, specifications, availability, colors, variants, shipping, returns, and any product-related questions\n2. If asked about product availability or colors, provide helpful information. For example, if asked \"Can I get Red?\" or \"Do you have it in red?\", explain the available colors (Black, Silver, Blue) and that red is not currently available\n3. If asked about unrelated topics (cooking, baking, recipes, weather, sports, politics, general knowledge, completely different products), politely redirect: \"I'm here to help you with this product. Would you like to know about its features, reviews, or specifications?\"\n4. Be helpful, friendly, and concise\n5. Reference specific reviews when relevant to answer questions\n6. If asked about availability, mention it's ${\n      product.inStock ? \"currently in stock\" : \"currently out of stock\"\n    }\n7. Help with purchase decisions by comparing features, mentioning reviews, and highlighting value\n8. Answer questions about product variants, colors, and options naturally and helpfully`;\n\n    const APP_ID = process.env.AGORA_APP_ID;\n    const API_KEY = process.env.AGORA_API_KEY;\n    const API_SECRET = process.env.AGORA_API_SECRET;\n\n    if (!APP_ID || !API_KEY || !API_SECRET) {\n      return NextResponse.json(\n        { error: \"Missing Agora credentials\" },\n        { status: 500 }\n      );\n    }\n\n    // Generate token for agent (UID 1000)\n    const APP_CERTIFICATE = process.env.AGORA_APP_CERTIFICATE;\n    if (!APP_CERTIFICATE) {\n      return NextResponse.json(\n        { error: \"Missing APP_CERTIFICATE\" },\n        { status: 500 }\n      );\n    }\n\n    const role = RtcRole.PUBLISHER;\n    const expirationTimeInSeconds = 3600;\n    const currentTimestamp = Math.floor(Date.now() / 1000);\n    const privilegeExpiredTs = currentTimestamp + expirationTimeInSeconds;\n    const agentRtmUserId = \"1000\"; // Agent RTM user ID\n\n    // Generate token valid for both RTC and RTM for the agent\n    // RTC UID: 1000 (numeric to match agent_rtc_uid), RTM UID: \"1000\" (string)\n    const agentToken = RtcTokenBuilder.buildTokenWithRtm2(\n      APP_ID,\n      APP_CERTIFICATE,\n      channel,\n      1000, // RTC UID (numeric, matches agent_rtc_uid \"1000\")\n      role,\n      privilegeExpiredTs, // token expiration\n      privilegeExpiredTs, // join channel privilege\n      privilegeExpiredTs, // publish audio privilege\n      privilegeExpiredTs, // publish video privilege\n      privilegeExpiredTs, // publish data stream privilege\n      agentRtmUserId, // RTM user ID (string \"1000\")\n      privilegeExpiredTs // RTM token expiration\n    );\n\n    const auth = Buffer.from(`${API_KEY}:${API_SECRET}`).toString(\"base64\");\n\n    const payload = {\n      name: `ecommerce_ai_agent_${Date.now()}_${Math.random()\n        .toString(36)\n        .substring(7)}`,\n      properties: {\n        channel: channel,\n        token: agentToken,\n        agent_rtc_uid: \"1000\",\n        remote_rtc_uids: [`${Number(userId)}`],\n        idle_timeout: 120,\n        advanced_features: {\n          enable_rtm: true, // Start the Signaling service (required for transcripts)\n        },\n        parameters: {\n          data_channel: \"rtm\", // Enable Signaling as the data transmission channel (required for transcripts)\n        },\n        llm: {\n          url:\n            process.env.LLM_URL || \"https://api.openai.com/v1/chat/completions\",\n          api_key: process.env.LLM_API_KEY || \"\",\n          system_messages: [\n            {\n              role: \"system\",\n              content: context,\n            },\n          ],\n          greeting_message:\n            \"Hello! I'm here to help you with this product. Ask me anything about features, reviews, or specifications!\",\n          failure_message:\n            \"I'm sorry, I can only assist with questions related to this product. Could you please ask about our product?\",\n          max_history: 10,\n          params: {\n            model: process.env.LLM_MODEL || \"gpt-4o-mini\",\n          },\n        },\n        asr: {\n          language: \"en-US\",\n        },\n        tts: {\n          vendor: \"microsoft\",\n          params: {\n            key: process.env.TTS_API_KEY || \"\",\n            region: process.env.TTS_REGION || \"eastus\",\n            voice_name: \"en-US-AndrewMultilingualNeural\",\n            rate: \"1.3\",\n          },\n        },\n      },\n    };\n\n    console.log(`[start-agent] Agent token (UID 1000): ${agentToken}`);\n    console.log(`[start-agent] User token (UID ${userId}): ${token}`);\n    console.log(\n      `[start-agent] Complete /join payload:`,\n      JSON.stringify(payload, null, 2)\n    );\n\n    const response = await axios.post(\n      `https://api.agora.io/api/conversational-ai-agent/v2/projects/${APP_ID}/join`,\n      payload,\n      {\n        headers: {\n          Authorization: `Basic ${auth}`,\n          \"Content-Type\": \"application/json\",\n        },\n      }\n    );\n\n    console.log(\"Response:\", JSON.stringify(response.data, null, 2));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    const err = error as any;\n    const status = err?.response?.status;\n    const data = err?.response?.data;\n\n    // Handle 409 Conflict - agent already running\n    if (status === 409 && data?.agent_id) {\n      console.log(\n        \"Agent already running, returning existing agent:\",\n        data.agent_id\n      );\n      return NextResponse.json({\n        agent_id: data.agent_id,\n        status: data.status || \"RUNNING\",\n        create_ts: data.create_ts,\n        ...data,\n      });\n    }\n\n    const message =\n      data?.detail ||\n      data?.message ||\n      err?.message ||\n      \"Failed to start AI agent\";\n\n    console.error(\n      \"[start-agent] error:\",\n      JSON.stringify(data || err?.message, null, 2)\n    );\n    return NextResponse.json(\n      { error: message, detail: data || err?.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}