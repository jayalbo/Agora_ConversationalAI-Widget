{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/app/api/agora/initialize/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pkg from \"agora-token\";\nconst { RtcTokenBuilder, RtcRole } = pkg;\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { userId } = body;\n    const uid = userId ? parseInt(userId) : Math.floor(Math.random() * 100000);\n    const channel = `channel_${Date.now()}_${Math.random()\n      .toString(36)\n      .substring(7)}`;\n\n    const APP_ID = process.env.AGORA_APP_ID;\n    const APP_CERTIFICATE = process.env.AGORA_APP_CERTIFICATE;\n\n    if (!APP_ID || !APP_CERTIFICATE) {\n      return NextResponse.json(\n        { error: \"Missing Agora credentials\" },\n        { status: 500 }\n      );\n    }\n\n    const role = RtcRole.PUBLISHER;\n    const expirationTimeInSeconds = 3600;\n    const currentTimestamp = Math.floor(Date.now() / 1000);\n    const privilegeExpiredTs = currentTimestamp + expirationTimeInSeconds;\n    const rtmUserId = uid.toString(); // RTM user ID as string\n\n    // Generate token valid for both RTC and RTM\n    // buildTokenWithRtm2: (appId, appCertificate, channelName, uid, role, privilegeExpiredTs, \n    //                     joinChannelPrivilegeExpiredTs, pubAudioPrivilegeExpiredTs, \n    //                     pubVideoPrivilegeExpiredTs, pubDataStreamPrivilegeExpiredTs,\n    //                     rtmUid, rtmPrivilegeExpiredTs)\n    const token = RtcTokenBuilder.buildTokenWithRtm2(\n      APP_ID,\n      APP_CERTIFICATE,\n      channel,\n      uid, // RTC UID (numeric)\n      role,\n      privilegeExpiredTs, // token expiration\n      privilegeExpiredTs, // join channel privilege\n      privilegeExpiredTs, // publish audio privilege\n      privilegeExpiredTs, // publish video privilege\n      privilegeExpiredTs, // publish data stream privilege\n      rtmUserId, // RTM user ID (string)\n      privilegeExpiredTs // RTM token expiration\n    );\n\n    const response = {\n      token,\n      appId: process.env.AGORA_APP_ID,\n      channel: channel,\n      uid: uid,\n      rtmUserId: rtmUserId, // RTM user ID for text messaging\n    };\n\n    console.log(`\\n[POST] /api/agora/initialize`);\n    console.log(\"Request:\", JSON.stringify(body, null, 2));\n    console.log(\"Response:\", JSON.stringify(response, null, 2));\n\n    return NextResponse.json(response);\n  } catch (error) {\n    return NextResponse.json(\n      { error: \"Failed to initialize Agora session\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AACA,MAAM,EAAE,eAAe,EAAE,OAAO,EAAE,GAAG,oJAAG;AAEjC,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,GAAG;QACnB,MAAM,MAAM,SAAS,SAAS,UAAU,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK;QACnE,MAAM,UAAU,CAAC,QAAQ,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GACjD,QAAQ,CAAC,IACT,SAAS,CAAC,IAAI;QAEjB,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY;QACvC,MAAM,kBAAkB,QAAQ,GAAG,CAAC,qBAAqB;QAEzD,IAAI,CAAC,UAAU,CAAC,iBAAiB;YAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,QAAQ,SAAS;QAC9B,MAAM,0BAA0B;QAChC,MAAM,mBAAmB,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;QACjD,MAAM,qBAAqB,mBAAmB;QAC9C,MAAM,YAAY,IAAI,QAAQ,IAAI,wBAAwB;QAE1D,4CAA4C;QAC5C,2FAA2F;QAC3F,kFAAkF;QAClF,mFAAmF;QACnF,qDAAqD;QACrD,MAAM,QAAQ,gBAAgB,kBAAkB,CAC9C,QACA,iBACA,SACA,KACA,MACA,oBACA,oBACA,oBACA,oBACA,oBACA,WACA,mBAAmB,uBAAuB;;QAG5C,MAAM,WAAW;YACf;YACA,OAAO,QAAQ,GAAG,CAAC,YAAY;YAC/B,SAAS;YACT,KAAK;YACL,WAAW;QACb;QAEA,QAAQ,GAAG,CAAC,CAAC,8BAA8B,CAAC;QAC5C,QAAQ,GAAG,CAAC,YAAY,KAAK,SAAS,CAAC,MAAM,MAAM;QACnD,QAAQ,GAAG,CAAC,aAAa,KAAK,SAAS,CAAC,UAAU,MAAM;QAExD,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAqC,GAC9C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}