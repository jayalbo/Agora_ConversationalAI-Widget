{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/agoraClient.ts"],"sourcesContent":["import axios from \"axios\";\nimport pkg from \"agora-token\";\nconst { RtcTokenBuilder, RtcRole } = pkg;\n\nconst APP_ID = process.env.AGORA_APP_ID;\nconst APP_CERTIFICATE = process.env.AGORA_APP_CERTIFICATE;\nconst API_KEY = process.env.AGORA_API_KEY;\nconst API_SECRET = process.env.AGORA_API_SECRET;\n\nfunction assertAgoraEnv() {\n  if (!APP_ID || !APP_CERTIFICATE || !API_KEY || !API_SECRET) {\n    throw new Error(\n      \"Missing Agora credentials. Please set AGORA_APP_ID, AGORA_APP_CERTIFICATE, AGORA_API_KEY, AGORA_API_SECRET.\"\n    );\n  }\n}\n\n// Generate RTC token using Agora's official SDK\nexport function generateToken(channelName: string, uid: number) {\n  assertAgoraEnv();\n  if (!APP_ID || !APP_CERTIFICATE) {\n    throw new Error(\"Missing APP_ID or APP_CERTIFICATE\");\n  }\n\n  const role = RtcRole.PUBLISHER;\n  const expirationTimeInSeconds = 3600;\n  const currentTimestamp = Math.floor(Date.now() / 1000);\n  const privilegeExpiredTs = currentTimestamp + expirationTimeInSeconds;\n\n  const token = RtcTokenBuilder.buildTokenWithUid(\n    APP_ID,\n    APP_CERTIFICATE,\n    channelName,\n    uid,\n    role,\n    privilegeExpiredTs,\n    privilegeExpiredTs\n  );\n\n  return token;\n}\n\n// Process chat message using LLM directly (for text fallback)\nexport async function processChatMessage(\n  message: string,\n  context: string,\n  productId: string\n) {\n  try {\n    const llmUrl =\n      process.env.LLM_URL || \"https://api.openai.com/v1/chat/completions\";\n    const llmApiKey = process.env.LLM_API_KEY || \"\";\n    const llmModel = process.env.LLM_MODEL || \"gpt-4o-mini\";\n\n    const response = await axios.post(\n      llmUrl,\n      {\n        model: llmModel,\n        messages: [\n          {\n            role: \"system\",\n            content: context,\n          },\n          {\n            role: \"user\",\n            content: message,\n          },\n        ],\n        max_tokens: 500,\n        temperature: 0.7,\n      },\n      {\n        headers: {\n          Authorization: `Bearer ${llmApiKey}`,\n          \"Content-Type\": \"application/json\",\n        },\n      }\n    );\n\n    return {\n      response:\n        response.data.choices[0]?.message?.content ||\n        \"I'm sorry, I couldn't process that message.\",\n    };\n  } catch (error: any) {\n    console.error(\"Chat error:\", error?.response?.data || error?.message);\n    return {\n      response:\n        \"I'm having trouble processing that right now. Could you rephrase your question about the product?\",\n    };\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AACA,MAAM,EAAE,eAAe,EAAE,OAAO,EAAE,GAAG,oJAAG;AAExC,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY;AACvC,MAAM,kBAAkB,QAAQ,GAAG,CAAC,qBAAqB;AACzD,MAAM,UAAU,QAAQ,GAAG,CAAC,aAAa;AACzC,MAAM,aAAa,QAAQ,GAAG,CAAC,gBAAgB;AAE/C,SAAS;IACP,IAAI,CAAC,UAAU,CAAC,mBAAmB,CAAC,WAAW,CAAC,YAAY;QAC1D,MAAM,IAAI,MACR;IAEJ;AACF;AAGO,SAAS,cAAc,WAAmB,EAAE,GAAW;IAC5D;IACA,IAAI,CAAC,UAAU,CAAC,iBAAiB;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,OAAO,QAAQ,SAAS;IAC9B,MAAM,0BAA0B;IAChC,MAAM,mBAAmB,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;IACjD,MAAM,qBAAqB,mBAAmB;IAE9C,MAAM,QAAQ,gBAAgB,iBAAiB,CAC7C,QACA,iBACA,aACA,KACA,MACA,oBACA;IAGF,OAAO;AACT;AAGO,eAAe,mBACpB,OAAe,EACf,OAAe,EACf,SAAiB;IAEjB,IAAI;QACF,MAAM,SACJ,QAAQ,GAAG,CAAC,OAAO,IAAI;QACzB,MAAM,YAAY,QAAQ,GAAG,CAAC,WAAW,IAAI;QAC7C,MAAM,WAAW,QAAQ,GAAG,CAAC,SAAS,IAAI;QAE1C,MAAM,WAAW,MAAM,kJAAK,CAAC,IAAI,CAC/B,QACA;YACE,OAAO;YACP,UAAU;gBACR;oBACE,MAAM;oBACN,SAAS;gBACX;gBACA;oBACE,MAAM;oBACN,SAAS;gBACX;aACD;YACD,YAAY;YACZ,aAAa;QACf,GACA;YACE,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,WAAW;gBACpC,gBAAgB;YAClB;QACF;QAGF,OAAO;YACL,UACE,SAAS,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,SAAS,WACnC;QACJ;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,eAAe,OAAO,UAAU,QAAQ,OAAO;QAC7D,OAAO;YACL,UACE;QACJ;IACF;AACF"}},
    {"offset": {"line": 195, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/app/api/agora/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { processChatMessage } from '@/lib/agoraClient';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { message, context, productId } = body;\n\n    if (!message || !context) {\n      return NextResponse.json(\n        { error: \"Message and context are required\" },\n        { status: 400 }\n      );\n    }\n\n    const result = await processChatMessage(message, context, productId);\n    \n    console.log(`\\n[POST] /api/agora/chat`);\n    console.log(\"Request:\", JSON.stringify(body, null, 2));\n    console.log(\"Response:\", JSON.stringify(result, null, 2));\n    \n    return NextResponse.json(result);\n  } catch (error) {\n    return NextResponse.json(\n      { error: \"Failed to process chat message\" },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG;QAExC,IAAI,CAAC,WAAW,CAAC,SAAS;YACxB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmC,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,IAAA,0IAAkB,EAAC,SAAS,SAAS;QAE1D,QAAQ,GAAG,CAAC,CAAC,wBAAwB,CAAC;QACtC,QAAQ,GAAG,CAAC,YAAY,KAAK,SAAS,CAAC,MAAM,MAAM;QACnD,QAAQ,GAAG,CAAC,aAAa,KAAK,SAAS,CAAC,QAAQ,MAAM;QAEtD,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAiC,GAC1C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}